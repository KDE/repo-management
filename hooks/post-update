#!/bin/bash

mgmtdir="/home/git/repo-management"
currpath=$(pwd)
urlpath=${currpath#/srv/git/repositories/}
urlpath=${urlpath#/home/git/repositories/}
reponame=${urlpath%.git}

# Poking anongit mirrors to cause immediate update
for mirror in `cat $mgmtdir/config/enabled_anongits.cfg`; do
       mirror=$(dig +short $mirror)
       nohup curl --resolve anongit.kde.org:443:$mirror https://anongit.kde.org/updateRepo/$urlpath < /dev/null &>/dev/null &!
done

# Trigger Github update
# Only mainline repositories are to be mirrored - no scratch, clones, websites or sysadmin repos
if [[ $urlpath != *"/"* ]] && [[ $urlpath != "gitolite-admin.git" ]]; then
    nohup bash $mgmtdir/github-sync/sync-to-github.sh "$reponame" "$urlpath" < /dev/null &> /dev/null &!
fi

# Initiate remote server update
remote_update_url=$mgmtdir/repo-configs/remote-update/$urlpath
if [ -f $remote_update_url ]; then
    remoteurl=`cat $remote_update_url`
    python $mgmtdir/helpers/update-repo-mirror.py $urlpath $remoteurl &> /dev/null &
fi

# Update local information
git update-server-info

# Trigger Phabricator to update
curl https://phabricator.kde.org/api/diffusion.looksoon -d api.token=`cat ~/phabricator-apitoken` -d repositories[0]="${reponame}" -s -o /dev/null

# Trigger Jenkins to build
nohup bash $mgmtdir/helpers/trigger-jenkins.sh "$urlpath" < /dev/null &> /dev/null &!

# Repository specific hooks - Trojita
if [[ "$urlpath" == "trojita.git" ]]; then
    obsauth=`cat ${HOME}/trojita-obs-credentials`
    nohup curl --connect-timeout 10 --max-time 10 --user $obsauth -X POST -H 'Content-Length: 0' 'https://api.opensuse.org/source/home:jkt-gentoo:trojita/trojita-nightly/?cmd=runservice' &>/dev/null
fi
