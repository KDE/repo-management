#!/bin/bash

mgmtdir="/home/git/repo-management"
metadatadir="/home/git/kde-build-metadata/"
kdedevscripts="/home/git/kde-dev-scripts/"
kdeprojects="/home/git/kde_projects.xml"
currpath=$(pwd)
urlpath=${currpath#/srv/git/repositories/}
reponame=${urlpath%.git}

# Poking anongit mirrors to cause immediate update
for mirror in `cat $mgmtdir/config/enabled_anongits.cfg`; do
       mirror=$(dig +short $mirror)
       curl --connect-timeout 1 --max-time 1 --resolve anongit.kde.org:80:$mirror http://anongit.kde.org/updateRepo/$urlpath &>/dev/null
done

# Initiate remote server update
remote_update_url=$mgmtdir/repo-configs/remote-update/$urlpath
if [ -f $remote_update_url ]; then
    remoteurl=`cat $remote_update_url`
    python $mgmtdir/bin/update-repo-mirror.py $urlpath $remoteurl &> /dev/null &
fi

# Initiate Github update
# Only mainline repositories are to be mirrored - no scratch, clones, websites or sysadmin repos
if [[ $urlpath != *"/"* ]] && [[ $urlpath != "gitolite-admin.git" ]]; then
    bash $mgmtdir/bin/sync-to-github.sh "$reponame" "$urlpath" &
fi

# Update local information
git update-server-info

# Trigger Jenkins to build - wait 10s to ensure anongit is synced
jenkinsauth=`cat ${HOME}/jenkins-credentials`
sleep 10s && curl --connect-timeout 10 --max-time 10 "https://build.kde.org/git/notifyCommit?url=git://anongit.kde.org/$urlpath" &> /dev/null &
#sleep 10s && curl --connect-timeout 10 --max-time 10 "https://build-sandbox.kde.org/git/notifyCommit?url=git://anongit.kde.org/$urlpath" &> /dev/null &

# Repository specific hooks - kde-build-metadata
if [[ "$urlpath" == "kde-build-metadata.git" ]]; then
    curl --connect-timeout 10 --max-time 10 "https://build.kde.org/job/kde_project_dsl_orig/build?token=${jenkinsauth}-kde_project_dsl_orig&cause=Commit%20to%20kde-build-metadata" &> /dev/null
#    curl --connect-timeout 10 --max-time 10 "https://build-sandbox.kde.org/job/dsl_seed_job/build?token=${jenkinsauth}-kde_seed_dsl&cause=Commit%20to%20kde-build-metadata" &> /dev/null
fi

# Repository specific hooks - ci-builder-tools
if [[ "$urlpath" == "ci-builder-tools.git" ]]; then
    curl --connect-timeout 10 --max-time 10 "https://build.kde.org/job/update_nodes/build?token=${jenkinsauth}-update_nodes&cause=Commit%20to%20ci_builder_tools" &> /dev/null
#    curl --connect-timeout 10 --max-time 10 "https://build-sandbox.kde.org/job/update_nodes/build?token=${jenkinsauth}-update_nodes&cause=Commit%20to%20ci_builder_tools" &> /dev/null
fi

# Repository specific hooks - ci-experimental-tools
if [[ "$urlpath" == "ci-tools-experimental.git" ]]; then
    curl --connect-timeout 10 --max-time 10 "https://build-sandbox.kde.org/job/kde_project_dsl_orig/build?token=${jenkinsauth}-kde_project_dsl_orig&cause=Commit%20to%20ci-tools-experimental" &> /dev/null
fi

# Repository specific hooks - android-builder
if [[ "$urlpath" == "android-builder.git" ]]; then
    curl --connect-timeout 10 --max-time 10 "https://build-sandbox.kde.org/job/create_android_node/build?token=${jenkinsauth}-create-android-node&cause=Commit%20to%20android-builder" &> /dev/null
fi

# Repository specific hooks - Trojita
if [[ "$urlpath" == "trojita.git" ]]; then
    obsauth=`cat ${HOME}/trojita-obs-credentials`
    curl --connect-timeout 10 --max-time 10 --user $obsauth -X POST -H 'Content-Length: 0' 'https://api.opensuse.org/source/home:jkt-gentoo:trojita/trojita-nightly/?cmd=runservice' &>/dev/null
fi

